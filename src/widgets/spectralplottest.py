from PyQt6.QtWidgets import QWidget, QVBoxLayout
from PyQt6.QtCore import QPoint, Qt
from PyQt6.QtGui import QMouseEvent
from PyQt6 import QtGui
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qtagg import FigureCanvasQTAgg
from matplotlib.figure import Figure
from matplotlib import cm
from .scenewidget import SceneWidget
from luxpy import plot_spectrum_colors ,spd, vlbar_cie_mesopic, spectrum, cri_ref


class SpectralPlotWidget(SceneWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.data = None
        self.plt = plt
        # self.plt.style.use('dark_background')

        self.init_ui()

    def init_ui(self):
        layout = QVBoxLayout()
        self.setLayout(layout)
        self.pc = MplCanvas(self)
        layout.addWidget(self.pc)
    def setSpectralData(self, data):
            self.data = data
            self.plot_data()

    def plot_data(self):
        buffer_data = np.array([[3.8000e+02, 3.8100e+02, 3.8200e+02, 3.8300e+02, 3.8400e+02,
    3.8500e+02, 3.8600e+02, 3.8700e+02, 3.8800e+02, 3.8900e+02,
    3.9000e+02, 3.9100e+02, 3.9200e+02, 3.9300e+02, 3.9400e+02,
    3.9500e+02, 3.9600e+02, 3.9700e+02, 3.9800e+02, 3.9900e+02,
    4.0000e+02, 4.0100e+02, 4.0200e+02, 4.0300e+02, 4.0400e+02,
    4.0500e+02, 4.0600e+02, 4.0700e+02, 4.0800e+02, 4.0900e+02,
    4.1000e+02, 4.1100e+02, 4.1200e+02, 4.1300e+02, 4.1400e+02,
    4.1500e+02, 4.1600e+02, 4.1700e+02, 4.1800e+02, 4.1900e+02,
    4.2000e+02, 4.2100e+02, 4.2200e+02, 4.2300e+02, 4.2400e+02,
    4.2500e+02, 4.2600e+02, 4.2700e+02, 4.2800e+02, 4.2900e+02,
    4.3000e+02, 4.3100e+02, 4.3200e+02, 4.3300e+02, 4.3400e+02,
    4.3500e+02, 4.3600e+02, 4.3700e+02, 4.3800e+02, 4.3900e+02,
    4.4000e+02, 4.4100e+02, 4.4200e+02, 4.4300e+02, 4.4400e+02,
    4.4500e+02, 4.4600e+02, 4.4700e+02, 4.4800e+02, 4.4900e+02,
    4.5000e+02, 4.5100e+02, 4.5200e+02, 4.5300e+02, 4.5400e+02,
    4.5500e+02, 4.5600e+02, 4.5700e+02, 4.5800e+02, 4.5900e+02,
    4.6000e+02, 4.6100e+02, 4.6200e+02, 4.6300e+02, 4.6400e+02,
    4.6500e+02, 4.6600e+02, 4.6700e+02, 4.6800e+02, 4.6900e+02,
    4.7000e+02, 4.7100e+02, 4.7200e+02, 4.7300e+02, 4.7400e+02,
    4.7500e+02, 4.7600e+02, 4.7700e+02, 4.7800e+02, 4.7900e+02,
    4.8000e+02, 4.8100e+02, 4.8200e+02, 4.8300e+02, 4.8400e+02,
    4.8500e+02, 4.8600e+02, 4.8700e+02, 4.8800e+02, 4.8900e+02,
    4.9000e+02, 4.9100e+02, 4.9200e+02, 4.9300e+02, 4.9400e+02,
    4.9500e+02, 4.9600e+02, 4.9700e+02, 4.9800e+02, 4.9900e+02,
    5.0000e+02, 5.0100e+02, 5.0200e+02, 5.0300e+02, 5.0400e+02,
    5.0500e+02, 5.0600e+02, 5.0700e+02, 5.0800e+02, 5.0900e+02,
    5.1000e+02, 5.1100e+02, 5.1200e+02, 5.1300e+02, 5.1400e+02,
    5.1500e+02, 5.1600e+02, 5.1700e+02, 5.1800e+02, 5.1900e+02,
    5.2000e+02, 5.2100e+02, 5.2200e+02, 5.2300e+02, 5.2400e+02,
    5.2500e+02, 5.2600e+02, 5.2700e+02, 5.2800e+02, 5.2900e+02,
    5.3000e+02, 5.3100e+02, 5.3200e+02, 5.3300e+02, 5.3400e+02,
    5.3500e+02, 5.3600e+02, 5.3700e+02, 5.3800e+02, 5.3900e+02,
    5.4000e+02, 5.4100e+02, 5.4200e+02, 5.4300e+02, 5.4400e+02,
    5.4500e+02, 5.4600e+02, 5.4700e+02, 5.4800e+02, 5.4900e+02,
    5.5000e+02, 5.5100e+02, 5.5200e+02, 5.5300e+02, 5.5400e+02,
    5.5500e+02, 5.5600e+02, 5.5700e+02, 5.5800e+02, 5.5900e+02,
    5.6000e+02, 5.6100e+02, 5.6200e+02, 5.6300e+02, 5.6400e+02,
    5.6500e+02, 5.6600e+02, 5.6700e+02, 5.6800e+02, 5.6900e+02,
    5.7000e+02, 5.7100e+02, 5.7200e+02, 5.7300e+02, 5.7400e+02,
    5.7500e+02, 5.7600e+02, 5.7700e+02, 5.7800e+02, 5.7900e+02,
    5.8000e+02, 5.8100e+02, 5.8200e+02, 5.8300e+02, 5.8400e+02,
    5.8500e+02, 5.8600e+02, 5.8700e+02, 5.8800e+02, 5.8900e+02,
    5.9000e+02, 5.9100e+02, 5.9200e+02, 5.9300e+02, 5.9400e+02,
    5.9500e+02, 5.9600e+02, 5.9700e+02, 5.9800e+02, 5.9900e+02,
    6.0000e+02, 6.0100e+02, 6.0200e+02, 6.0300e+02, 6.0400e+02,
    6.0500e+02, 6.0600e+02, 6.0700e+02, 6.0800e+02, 6.0900e+02,
    6.1000e+02, 6.1100e+02, 6.1200e+02, 6.1300e+02, 6.1400e+02,
    6.1500e+02, 6.1600e+02, 6.1700e+02, 6.1800e+02, 6.1900e+02,
    6.2000e+02, 6.2100e+02, 6.2200e+02, 6.2300e+02, 6.2400e+02,
    6.2500e+02, 6.2600e+02, 6.2700e+02, 6.2800e+02, 6.2900e+02,
    6.3000e+02, 6.3100e+02, 6.3200e+02, 6.3300e+02, 6.3400e+02,
    6.3500e+02, 6.3600e+02, 6.3700e+02, 6.3800e+02, 6.3900e+02,
    6.4000e+02, 6.4100e+02, 6.4200e+02, 6.4300e+02, 6.4400e+02,
    6.4500e+02, 6.4600e+02, 6.4700e+02, 6.4800e+02, 6.4900e+02,
    6.5000e+02, 6.5100e+02, 6.5200e+02, 6.5300e+02, 6.5400e+02,
    6.5500e+02, 6.5600e+02, 6.5700e+02, 6.5800e+02, 6.5900e+02,
    6.6000e+02, 6.6100e+02, 6.6200e+02, 6.6300e+02, 6.6400e+02,
    6.6500e+02, 6.6600e+02, 6.6700e+02, 6.6800e+02, 6.6900e+02,
    6.7000e+02, 6.7100e+02, 6.7200e+02, 6.7300e+02, 6.7400e+02,
    6.7500e+02, 6.7600e+02, 6.7700e+02, 6.7800e+02, 6.7900e+02,
    6.8000e+02, 6.8100e+02, 6.8200e+02, 6.8300e+02, 6.8400e+02,
    6.8500e+02, 6.8600e+02, 6.8700e+02, 6.8800e+02, 6.8900e+02,
    6.9000e+02, 6.9100e+02, 6.9200e+02, 6.9300e+02, 6.9400e+02,
    6.9500e+02, 6.9600e+02, 6.9700e+02, 6.9800e+02, 6.9900e+02,
    7.0000e+02, 7.0100e+02, 7.0200e+02, 7.0300e+02, 7.0400e+02,
    7.0500e+02, 7.0600e+02, 7.0700e+02, 7.0800e+02, 7.0900e+02,
    7.1000e+02, 7.1100e+02, 7.1200e+02, 7.1300e+02, 7.1400e+02,
    7.1500e+02, 7.1600e+02, 7.1700e+02, 7.1800e+02, 7.1900e+02,
    7.2000e+02, 7.2100e+02, 7.2200e+02, 7.2300e+02, 7.2400e+02,
    7.2500e+02, 7.2600e+02, 7.2700e+02, 7.2800e+02, 7.2900e+02,
    7.3000e+02, 7.3100e+02, 7.3200e+02, 7.3300e+02, 7.3400e+02,
    7.3500e+02, 7.3600e+02, 7.3700e+02, 7.3800e+02, 7.3900e+02,
    7.4000e+02, 7.4100e+02, 7.4200e+02, 7.4300e+02, 7.4400e+02,
    7.4500e+02, 7.4600e+02, 7.4700e+02, 7.4800e+02, 7.4900e+02,
    7.5000e+02, 7.5100e+02, 7.5200e+02, 7.5300e+02, 7.5400e+02,
    7.5500e+02, 7.5600e+02, 7.5700e+02, 7.5800e+02, 7.5900e+02,
    7.6000e+02, 7.6100e+02, 7.6200e+02, 7.6300e+02, 7.6400e+02,
    7.6500e+02, 7.6600e+02, 7.6700e+02, 7.6800e+02, 7.6900e+02,
    7.7000e+02, 7.7100e+02, 7.7200e+02, 7.7300e+02, 7.7400e+02,
    7.7500e+02, 7.7600e+02, 7.7700e+02, 7.7800e+02, 7.7900e+02,
    7.8000e+02],
   [1.5285e-04, 1.5669e-04, 1.6054e-04, 1.6219e-04, 1.6385e-04,
    1.5609e-04, 1.4832e-04, 1.4374e-04, 1.3917e-04, 1.3567e-04,
    1.3217e-04, 1.3816e-04, 1.4415e-04, 1.5367e-04, 1.6319e-04,
    1.6772e-04, 1.7225e-04, 1.8319e-04, 1.9412e-04, 2.2677e-04,
    2.5942e-04, 2.5616e-04, 2.5289e-04, 2.8365e-04, 3.1441e-04,
    3.3193e-04, 3.4946e-04, 3.8213e-04, 4.1481e-04, 4.8651e-04,
    5.5820e-04, 6.5633e-04, 7.5445e-04, 8.6984e-04, 9.8523e-04,
    1.1605e-03, 1.3357e-03, 1.5668e-03, 1.7979e-03, 2.1065e-03,
    2.4152e-03, 2.8748e-03, 3.3344e-03, 3.9284e-03, 4.5223e-03,
    5.3567e-03, 6.1910e-03, 7.2957e-03, 8.4003e-03, 9.8369e-03,
    1.1273e-02, 1.3136e-02, 1.4998e-02, 1.7389e-02, 1.9781e-02,
    2.2621e-02, 2.5460e-02, 2.9048e-02, 3.2636e-02, 3.6704e-02,
    4.0773e-02, 4.5250e-02, 4.9728e-02, 5.4222e-02, 5.8716e-02,
    6.2123e-02, 6.5530e-02, 6.6800e-02, 6.8070e-02, 6.6715e-02,
    6.5359e-02, 6.1722e-02, 5.8085e-02, 5.3329e-02, 4.8573e-02,
    4.4139e-02, 3.9706e-02, 3.6104e-02, 3.2501e-02, 2.9776e-02,
    2.7051e-02, 2.4914e-02, 2.2776e-02, 2.1114e-02, 1.9452e-02,
    1.7933e-02, 1.6414e-02, 1.4967e-02, 1.3520e-02, 1.2249e-02,
    1.0978e-02, 1.0034e-02, 9.0903e-03, 8.3981e-03, 7.7058e-03,
    7.2103e-03, 6.7147e-03, 6.4041e-03, 6.0936e-03, 5.9386e-03,
    5.7837e-03, 5.6740e-03, 5.5642e-03, 5.5671e-03, 5.5699e-03,
    5.6304e-03, 5.6909e-03, 5.8402e-03, 5.9895e-03, 6.2625e-03,
    6.5355e-03, 6.9015e-03, 7.2675e-03, 7.7234e-03, 8.1793e-03,
    8.7459e-03, 9.3125e-03, 9.9989e-03, 1.0685e-02, 1.1531e-02,
    1.2377e-02, 1.3377e-02, 1.4378e-02, 1.5495e-02, 1.6612e-02,
    1.7901e-02, 1.9191e-02, 2.0604e-02, 2.2018e-02, 2.3582e-02,
    2.5147e-02, 2.6735e-02, 2.8322e-02, 2.9771e-02, 3.1220e-02,
    3.2477e-02, 3.3734e-02, 3.4588e-02, 3.5442e-02, 3.6005e-02,
    3.6568e-02, 3.6636e-02, 3.6703e-02, 3.6217e-02, 3.5732e-02,
    3.5008e-02, 3.4284e-02, 3.3222e-02, 3.2161e-02, 3.0984e-02,
    2.9807e-02, 2.8675e-02, 2.7542e-02, 2.6447e-02, 2.5351e-02,
    2.4385e-02, 2.3418e-02, 2.2583e-02, 2.1749e-02, 2.0982e-02,
    2.0215e-02, 1.9544e-02, 1.8874e-02, 1.8282e-02, 1.7689e-02,
    1.7128e-02, 1.6567e-02, 1.6032e-02, 1.5498e-02, 1.4994e-02,
    1.4490e-02, 1.4073e-02, 1.3656e-02, 1.3278e-02, 1.2900e-02,
    1.2569e-02, 1.2238e-02, 1.1977e-02, 1.1716e-02, 1.1516e-02,
    1.1316e-02, 1.1123e-02, 1.0930e-02, 1.0802e-02, 1.0674e-02,
    1.0560e-02, 1.0446e-02, 1.0374e-02, 1.0301e-02, 1.0255e-02,
    1.0208e-02, 1.0158e-02, 1.0108e-02, 1.0084e-02, 1.0060e-02,
    1.0061e-02, 1.0063e-02, 1.0071e-02, 1.0078e-02, 1.0104e-02,
    1.0131e-02, 1.0175e-02, 1.0220e-02, 1.0264e-02, 1.0309e-02,
    1.0357e-02, 1.0406e-02, 1.0467e-02, 1.0529e-02, 1.0599e-02,
    1.0668e-02, 1.0745e-02, 1.0822e-02, 1.0914e-02, 1.1006e-02,
    1.1086e-02, 1.1166e-02, 1.1251e-02, 1.1336e-02, 1.1448e-02,
    1.1561e-02, 1.1662e-02, 1.1763e-02, 1.1906e-02, 1.2049e-02,
    1.2226e-02, 1.2403e-02, 1.2581e-02, 1.2759e-02, 1.3031e-02,
    1.3303e-02, 1.3632e-02, 1.3962e-02, 1.4311e-02, 1.4661e-02,
    1.5099e-02, 1.5537e-02, 1.6127e-02, 1.6716e-02, 1.7450e-02,
    1.8183e-02, 1.9002e-02, 1.9821e-02, 2.0818e-02, 2.1814e-02,
    2.2930e-02, 2.4046e-02, 2.5272e-02, 2.6498e-02, 2.7811e-02,
    2.9124e-02, 3.0338e-02, 3.1552e-02, 3.2244e-02, 3.2937e-02,
    3.2650e-02, 3.2364e-02, 3.0919e-02, 2.9474e-02, 2.7192e-02,
    2.4910e-02, 2.2524e-02, 2.0137e-02, 1.8168e-02, 1.6199e-02,
    1.4727e-02, 1.3256e-02, 1.2172e-02, 1.1088e-02, 1.0309e-02,
    9.5310e-03, 8.9096e-03, 8.2881e-03, 7.8256e-03, 7.3631e-03,
    6.9947e-03, 6.6262e-03, 6.3540e-03, 6.0819e-03, 5.8463e-03,
    5.6107e-03, 5.4157e-03, 5.2207e-03, 5.0388e-03, 4.8568e-03,
    4.7098e-03, 4.5628e-03, 4.4196e-03, 4.2765e-03, 4.1600e-03,
    4.0435e-03, 3.9239e-03, 3.8042e-03, 3.6725e-03, 3.5408e-03,
    3.4495e-03, 3.3582e-03, 3.2664e-03, 3.1745e-03, 3.0751e-03,
    2.9757e-03, 2.8859e-03, 2.7961e-03, 2.7107e-03, 2.6252e-03,
    2.5425e-03, 2.4597e-03, 2.3894e-03, 2.3192e-03, 2.2423e-03,
    2.1653e-03, 2.1092e-03, 2.0530e-03, 1.9911e-03, 1.9291e-03,
    1.8694e-03, 1.8097e-03, 1.7574e-03, 1.7051e-03, 1.6452e-03,
    1.5853e-03, 1.5413e-03, 1.4973e-03, 1.4614e-03, 1.4255e-03,
    1.3825e-03, 1.3395e-03, 1.3019e-03, 1.2643e-03, 1.2146e-03,
    1.1648e-03, 1.1206e-03, 1.0764e-03, 1.0578e-03, 1.0392e-03,
    1.0047e-03, 9.7023e-04, 9.3687e-04, 9.0352e-04, 8.8140e-04,
    8.5929e-04, 8.3267e-04, 8.0605e-04, 7.7424e-04, 7.4242e-04,
    7.2287e-04, 7.0331e-04, 6.8505e-04, 6.6679e-04, 6.3700e-04,
    6.0722e-04, 5.9313e-04, 5.7903e-04, 5.6731e-04, 5.5560e-04,
    5.3307e-04, 5.1054e-04, 4.9643e-04, 4.8232e-04, 4.6049e-04,
    4.3866e-04, 4.2601e-04, 4.1336e-04, 4.0037e-04, 3.8739e-04,
    3.7490e-04, 3.6242e-04, 3.5663e-04, 3.5083e-04, 3.3686e-04,
    3.2289e-04, 3.1183e-04, 3.0076e-04, 2.9267e-04, 2.8458e-04,
    2.8062e-04, 2.7665e-04, 2.5899e-04, 2.4133e-04, 2.3466e-04,
    2.2800e-04, 2.2906e-04, 2.3012e-04, 2.2201e-04, 2.1390e-04,
    2.0518e-04, 1.9647e-04, 1.9332e-04, 1.9016e-04, 1.8212e-04,
    1.7408e-04, 1.6838e-04, 1.6269e-04, 1.5714e-04, 1.5158e-04,
    1.5133e-04, 1.5107e-04, 1.4641e-04, 1.4175e-04, 1.3449e-04,
    1.2723e-04]])

        df_RGBWW_SPD = np.ndarray(shape=(2, (buffer_data.shape[0] + 1)), buffer=buffer_data)
        lux_SPD = spd(df_RGBWW_SPD.T)

        plot_spectrum_colors(spd = lux_SPD[[0,-1],:], wavelength_height = 'spd', axh=self.pc.axes)

        self.pc.draw()

class MplCanvas(FigureCanvasQTAgg):
    def __init__(self, parent=None, width= int(300 / 96), height=int(300 / 96), dpi=300 / int(300 / 96)):
        fig = Figure(figsize=(width, height), dpi=dpi)
        self.axes = fig.add_subplot(111)
        super(MplCanvas, self).__init__(fig)
        # self.setCursor(QtGui.QCursor(Qt.CursorShape.ArrowCursor)) 
        
